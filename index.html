<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é­šè²¨æŸ¥è©¢ ğŸŸ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background-image: linear-gradient(to bottom, #f5f5f5, #e8e6df);
            font-family: 'Microsoft JhengHei', 'Noto Sans TC', sans-serif;
        }
        .emoji {
            font-size: 1.2rem;
            margin-right: 0.5rem;
        }
        .container {
            background: linear-gradient(to bottom right, #f0ece3, #e3ded4);
            border: 2px solid #d2c8b6;
        }
        input, select {
            background-color: #f5f3ed;
            border-color: #d2c8b6;
            color: #4a4a3c;
        }
        input::placeholder {
            color: #8a8a76;
        }
        button {
            background-color: #a8a891;
            color: #2f2f26;
        }
        button:hover {
            background-color: #989880;
        }
        h1, h3 {
            color: #3c3c2e;
        }
        p, label, #loading {
            color: #4a4a3c;
        }
        .result-item {
            background-color: #f9f8f3;
            border-color: #d2c8b6;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-6">
    <div class="w-full max-w-4xl container rounded-2xl shadow-lg p-8">
        <h1 class="text-4xl font-bold text-center mb-6">é­šåƒ¹æŸ¥è©¢ ğŸ âœ¨</h1>
        
        <div id="loading" class="text-xl text-center">æ­£åœ¨å¾æ”¿åºœè³‡æ–™é–‹æ”¾å¹³å°ä¸‹è¼‰è³‡æ–™...<br>
            è³‡æ–™è¼‰å…¥ä¸­... ğŸŒ¾</div>
        
        <div id="search" class="hidden flex flex-col sm:flex-row justify-center mb-6 gap-4">
            <input 
                type="text" 
                id="query" 
                placeholder="è¼¸å…¥æ¼ç²åç¨± (ä¾‹å¦‚ï¼šé¯–é­š) ğŸŸ" 
                class="w-full sm:max-w-md p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-[#a8a891]"
            />
            <button 
                id="searchButton" 
                class="p-3 rounded-lg hover:shadow-md transition"
            >
                æŸ¥è©¢ ğŸ”
            </button>
        </div>
        
        <div id="filters" class="hidden mb-6 flex flex-col sm:flex-row justify-center gap-4">
            <div class="text-center">
                <label for="marketSelect" class="text-lg font-semibold">é¸æ“‡åœ°é» ğŸŒ: </label>
                <select id="marketSelect" class="p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-[#a8a891]">
                    <option value="all">æ‰€æœ‰å€åŸŸ</option>
                </select>
            </div>
            <div class="text-center">
                <label for="dateSelect" class="text-lg font-semibold">é¸æ“‡æ—¥æœŸ ğŸ“…: </label>
                <select id="dateSelect" class="p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-[#a8a891]">
                    <option value="all">æ‰€æœ‰æ—¥æœŸ</option>
                </select>
            </div>
        </div>
        
        <div id="results" class="grid gap-6"></div>
    </div>

    <script>
        let data = [];
        let filteredResults = [];

        // è®€å– API
        fetch('https://data.moa.gov.tw/Service/OpenData/FromM/AquaticTransData.aspx?IsTransData=1&UnitId=039')
            .then(response => response.json())
            .then(jsonData => {
                data = jsonData;
                document.getElementById("loading").style.display = "none";
                document.getElementById("search").style.display = "flex";
            })
            .catch(error => {
                console.error('éŒ¯èª¤:', error);
                document.getElementById("loading").innerText = "è³‡æ–™è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚ ğŸ˜”";
                document.getElementById("loading").classList.add("text-[#4a4a3c]");
            });

        // é¡¯ç¤ºçµæœ
        function displayResults(results, market = 'all', date = 'all') {
            const resultsDiv = document.getElementById("results");
            resultsDiv.innerHTML = '';

            let filteredData = results;
            if (market !== 'all') {
                filteredData = filteredData.filter(item => item.å¸‚å ´åç¨± === market);
            }
            if (date !== 'all') {
                filteredData = filteredData.filter(item => item.äº¤æ˜“æ—¥æœŸ === date);
            }

            if (filteredData.length === 0) {
                resultsDiv.innerHTML = `
                    <div class="text-center text-[#4a4a3c]">ç„¡è³‡æ–™ç¬¦åˆæŸ¥è©¢æ¢ä»¶ ğŸ˜¿</div>
                `;
                return;
            }

            // æŒ‰äº¤æ˜“æ—¥æœŸã€é­šè²¨åç¨±ã€å¸‚å ´åç¨±ç¾¤çµ„
            const groupedData = filteredData.reduce((acc, item) => {
                const key = `${item.äº¤æ˜“æ—¥æœŸ}_${item.é­šè²¨åç¨±}_${item.å¸‚å ´åç¨±}`;
                if (!acc[key]) {
                    acc[key] = {
                        äº¤æ˜“æ—¥æœŸ: item.äº¤æ˜“æ—¥æœŸ,
                        é­šè²¨åç¨±: item.é­šè²¨åç¨±,
                        å¸‚å ´åç¨±: item.å¸‚å ´åç¨±,
                        ä¸Šåƒ¹: [],
                        ä¸­åƒ¹: [],
                        ä¸‹åƒ¹: [],
                        äº¤æ˜“é‡: [],
                        å¹³å‡åƒ¹: []
                    };
                }
                acc[key].ä¸Šåƒ¹.push(parseFloat(item.ä¸Šåƒ¹) || 0);
                acc[key].ä¸­åƒ¹.push(parseFloat(item.ä¸­åƒ¹) || 0);
                acc[key].ä¸‹åƒ¹.push(parseFloat(item.ä¸‹åƒ¹) || 0);
                acc[key].äº¤æ˜“é‡.push(parseFloat(item.äº¤æ˜“é‡) || 0);
                acc[key].å¹³å‡åƒ¹.push(parseFloat(item.å¹³å‡åƒ¹) || 0);
                return acc;
            }, {});

            // è¨ˆç®—å¹³å‡å€¼ä¸¦é¡¯ç¤º
            Object.values(groupedData).forEach(group => {
                const avg = (arr) => arr.length ? (arr.reduce((sum, val) => sum + val, 0) / arr.length).toFixed(2) : 'N/A';
                
                const resultItem = document.createElement("div");
                resultItem.className = "result-item p-6 rounded-lg shadow-md border";
                resultItem.innerHTML = `
                    <h3 class="text-xl font-semibold">${group.é­šè²¨åç¨±} ğŸ¡</h3>
                    <p><strong>äº¤æ˜“æ—¥æœŸ ğŸ“…:</strong> ${group.äº¤æ˜“æ—¥æœŸ}</p>
                    <p><strong>å¸‚å ´åç¨± ğŸ¬:</strong> ${group.å¸‚å ´åç¨±}</p>
                    <p><strong>å¹³å‡ä¸Šåƒ¹ ğŸ’°:</strong> ${avg(group.ä¸Šåƒ¹)}</p>
                    <p><strong>å¹³å‡ä¸­åƒ¹ ğŸ’¸:</strong> ${avg(group.ä¸­åƒ¹)}</p>
                    <p><strong>å¹³å‡ä¸‹åƒ¹ ğŸ¤‘:</strong> ${avg(group.ä¸‹åƒ¹)}</p>
                    <p><strong>å¹³å‡äº¤æ˜“é‡ ğŸ“¦:</strong> ${avg(group.äº¤æ˜“é‡)}</p>
                    <p><strong>å¹³å‡åƒ¹ ğŸ’²:</strong> ${avg(group.å¹³å‡åƒ¹)}</p>
                `;
                resultsDiv.appendChild(resultItem);
            });
        }

        // æŸ¥è©¢åŠŸèƒ½
        document.getElementById("searchButton").addEventListener("click", () => {
            const query = document.getElementById("query").value.toLowerCase();
            filteredResults = data.filter(item => 
                item.é­šè²¨åç¨±.toLowerCase().includes(query)
            );

            // é‡ç½®å¸‚å ´å’Œæ—¥æœŸé¸æ“‡
            const marketSelect = document.getElementById("marketSelect");
            const dateSelect = document.getElementById("dateSelect");
            marketSelect.innerHTML = '<option value="all">æ‰€æœ‰å€åŸŸ</option>';
            dateSelect.innerHTML = '<option value="all">æ‰€æœ‰æ—¥æœŸ</option>';
            document.getElementById("filters").style.display = filteredResults.length > 0 ? "flex" : "none";

            // å¡«å……å¸‚å ´ä¸‹æ‹‰é¸å–®
            const markets = [...new Set(filteredResults.map(item => item.å¸‚å ´åç¨±))];
            markets.forEach(market => {
                const option = document.createElement("option");
                option.value = market;
                option.textContent = market;
                marketSelect.appendChild(option);
            });

            // å¡«å……æ—¥æœŸä¸‹æ‹‰é¸å–®
            const dates = [...new Set(filteredResults.map(item => item.äº¤æ˜“æ—¥æœŸ))].sort();
            dates.forEach(date => {
                const option = document.createElement("option");
                option.value = date;
                option.textContent = date;
                dateSelect.appendChild(option);
            });

            // é¡¯ç¤ºåˆå§‹çµæœ
            displayResults(filteredResults);
        });

        // å¸‚å ´ç¯©é¸åŠŸèƒ½
        document.getElementById("marketSelect").addEventListener("change", (e) => {
            const selectedDate = document.getElementById("dateSelect").value;
            displayResults(filteredResults, e.target.value, selectedDate);
        });

        // æ—¥æœŸç¯©é¸åŠŸèƒ½
        document.getElementById("dateSelect").addEventListener("change", (e) => {
            const selectedMarket = document.getElementById("marketSelect").value;
            displayResults(filteredResults, selectedMarket, e.target.value);
        });
    </script>
</body>
</html>